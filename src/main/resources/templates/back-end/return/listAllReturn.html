<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>退貨處理</title>

<!-- Bootstrap -->
<link
	th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css}"
	rel="stylesheet" />
<link
	th:href="@{https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css}"
	rel="stylesheet" />

<!-- Font Awesome -->
<link
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css}"
	rel="stylesheet" />

<!-- 專案樣式 -->
<link th:href="@{/css/base.css}" rel="stylesheet" />
<link th:href="@{/css/orders.css}" rel="stylesheet" />
<!-- 後台首頁 -->
<link rel="stylesheet" th:href="@{/css/back-end-index.css}" />

</head>

<body>

	<!-- ========== 左側側邊欄 ========== -->
	<nav class="sidebar">
		<a class="mb-4 fs-4 text-decoration-none fw-bold"
			th:href="@{/back-end}">後台管理</a>
			
		<div
			class="mb-4 px-3 py-2 bg-light rounded shadow-sm border-start border-4 border-primary">
			<div th:if="${session.employeeId != null}">
				<div class="d-flex align-items-center mb-1">
					<i class="bi bi-person-badge-fill text-primary me-2 fs-5"></i> <span
						class="fw-bold text-dark" th:text="${session.employeeName}">管理員姓名</span>
				</div>
				<div class="text-muted" style="font-size: 0.85rem;">
					ID: <span th:text="${session.employeeId}">0</span>
				</div>
			</div>

			<div th:if="${session.employeeId == null}" class="py-1">
				<i class="bi bi-person-exclamation text-warning me-1"></i> <span
					class="text-muted small">尚未登入系統</span>
			</div>
		</div>

		<ul class="nav flex-column">
			<li class="nav-item"><a class="nav-link fs-5"
				th:href="@{/admin/mem/list}">會員管理</a></li>

			<!-- 折疊選單 -->
			<li class="nav-item fs-5"><a
				class="nav-link d-flex justify-content-between align-items-center "
				data-bs-toggle="collapse" href="#menu_products">商品管理<i
					class="bi bi-chevron-down"></i>
			</a>
				<div class="collapse fs-6" id="menu_products">
					<ul class="nav flex-column ms-3">
						<li><a class="nav-link" th:href="@{/prod/listAllProd}">商品列表</a></li>
						<li><a class="nav-link" th:href="@{/prod/addProd}">新增商品</a></li>
					</ul>
				</div></li>

			<!-- 訂單管理 -->
			<li class="nav-item fs-5"><a
				class="nav-link d-flex justify-content-between align-items-center "
				data-bs-toggle="collapse" href="#menu_orders">訂單管理<i
					class="bi bi-chevron-down"></i>
			</a>

				<div class="collapse fs-6 show" id="menu_orders">
					<ul class="nav flex-column ms-3">
						<li><a class="nav-link" th:href="@{/orders/list}">訂單紀錄</a></li>
						<li><a class="nav-link" th:href="@{/returns/list}">退貨處理</a></li>
					</ul>
				</div></li>
			<!-- 活動管理 -->
			<li class="nav-item fs-5"><a
				class="nav-link d-flex justify-content-between align-items-center "
				data-bs-toggle="collapse" href="#menu_activity">活動管理<i
					class="bi bi-chevron-down"></i>
			</a>

				<div class="collapse fs-6" id="menu_activity">
					<ul class="nav flex-column ms-3">
						<li><a class="nav-link" th:href="@{/coupon/getAllCoupon}">優惠券管理</a></li>
						<li><a class="nav-link"
							th:href="@{/promotions/getAllPromotions}">促銷管理</a></li>
					</ul>
				</div></li>
		</ul>

		<div class="mt-4 d-flex justify-content-center logout-wrapper">

			<button th:if="${session.employeeId != null}" type="button"
				class="btn btn-primary w-50 fw-bold btn-logout"
				data-bs-toggle="modal" data-bs-target="#logoutModal">
				<i class="bi bi-box-arrow-right"></i> 登出
			</button>

			<a th:if="${session.employeeId == null}" href="javascript:void(0)"
				th:data-login-url="@{/emp/login}" onclick="loginWithLocation(this)"
				class="btn btn-primary w-50 fw-bold"> <i
				class="bi bi-box-arrow-in-right"></i> 登入
			</a>

		</div>
	</nav>

	<!-- ================= Main ================= -->
	<main class="p-4">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb d-flex align-items-center no-bg">
				<li class="breadcrumb-item"><a th:href="@{/back-end}"
					class="fs-4 text-primary text-decoration-none fw-bold breadcrumb_index"><i
						class="bi bi-house-door-fill me-1"></i>後台管理</a></li>
				<li class="breadcrumb-item"><a th:href="@{/orders/list}"
					class="fs-5 text-primary text-decoration-none fw-bold breadcrumb_index">退貨處理</a>
				</li>
			</ol>
		</nav>
		<hr class="border border-primary border-2" />

		<div class="container-fluid">

			<!-- ================= 訊息提示區域 ================= -->
			<div th:if="${successMessage}"
				class="alert alert-success alert-dismissible fade show" role="alert">
				<i class="bi bi-check-circle-fill"></i> <span
					th:text="${successMessage}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>

			<div th:if="${errorMessage}"
				class="alert alert-danger alert-dismissible fade show" role="alert">
				<i class="bi bi-exclamation-circle-fill"></i> <span
					th:text="${errorMessage}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>

			<!-- ================= 退貨表格 ================= -->
			<table class="table table-hover align-middle">
				<thead class="order-thead text-center">
					<tr>
						<th>退貨編號</th>
						<th>訂單編號</th>
						<th>會員編號</th>
						<th>退貨原因</th>
						<th>退貨說明</th>
						<th>退貨狀態</th>
						<th>退貨拒絕原因</th>
						<th>退貨建立時間</th>
						<th>審核建立時間</th>
						<th>操作</th>
					</tr>
				</thead>

				<tbody>
					<!-- Thymeleaf 迴圈：訂單列表 -->
					<th:block th:each="orderData : ${orderListWithDetails}">
						<tr class="text-center">

							<td th:text="${orderData.order.orderId}"></td>
							<td th:text="${orderData.order.orderId}"></td>
							<td th:text="${orderData.order.memberId}"></td>
							<td th:text="${orderData.order.returnReason}"></td>
							<td th:text="${orderData.order.returnText}"></td>
							<td th:text="${orderData.order.returnStatus}"></td>
							<td th:text="${orderData.order.refusalReason}"></td>
							<td th:text="${orderData.order.returnCreateTime}"></td>
							<td th:text="${orderData.order.returnApproveTime}"></td>

							<!-- 操作 -->
							<td>
								<button type="button" class="btn btn-sm btn-primary"
									data-bs-toggle="collapse"
									th:data-bs-target="'#orderDetail-' + ${orderData.order.orderId}">
									<i class="bi bi-eye"></i> 查看
								</button>
							</td>

						</tr>

						<!-- 展開區域：訂單明細（伺服器端渲染，初始隱藏） -->
						<tr class="collapse-row">
							<td colspan="12" class="p-0">
								<div th:id="'orderDetail-' + ${orderData.order.orderId}"
									class="collapse">
									<div class="p-3 bg-light">
										<!-- 判斷是否有明細 -->
										<div th:if="${#lists.isEmpty(orderData.details)}"
											class="text-center text-muted py-3">此訂單無商品明細資料</div>
										<!-- 訂單明細表格 -->
										<table th:unless="${#lists.isEmpty(orderData.details)}"
											class="table table-sm table-bordered mb-0 align-middle">
											<thead class="table-light text-center">
												<tr>
													<th style="width: 100px;">商品圖片</th>
													<th>商品名稱</th>
													<th style="width: 120px;">尺寸</th>
													<th style="width: 80px;">數量</th>
													<th style="width: 100px;">單價</th>
													<th style="width: 100px;">小計</th>
													<th style="width: 100px;">類型</th>
												</tr>
											</thead>
											<tbody>
												<!-- Thymeleaf 迴圈：訂單明細 -->
												<tr th:each="detail : ${orderData.details}">
													<!-- 商品圖片 -->
													<td class="text-center"><img
														th:if="${detail.productImageBase64 != null and detail.isCustom == false}"
														th:src="${detail.productImageBase64}" alt="商品圖片"
														style="width: 80px; height: 80px; object-fit: cover;"
														onerror="this.src='/images/no-image.png';"> <i
														th:if="${detail.isCustom == true}"
														class="bi bi-palette fs-1 text-info"></i> <img
														th:if="${detail.productImageBase64 == null and detail.isCustom == false}"
														src="/images/no-image.png" alt="無圖片"
														style="width: 80px; height: 80px; object-fit: cover;">
													</td>

													<!-- 商品名稱 -->
													<td th:text="${detail.productName}"></td>

													<!-- 尺寸 -->
													<td class="text-center"><span
														th:if="${detail.width != null and detail.length != null}"
														th:text="${detail.width + ' x ' + detail.length + ' cm'}"></span>
														<span
														th:if="${detail.width == null or detail.length == null}">-</span>
													</td>

													<!-- 數量 -->
													<td class="text-center" th:text="${detail.quantity}"></td>

													<!-- 單價 -->
													<td class="text-end"><span
														th:text="'$' + ${#numbers.formatDecimal(detail.price, 1, 2)}"></span>
													</td>

													<!-- 小計 -->
													<td class="text-end fw-bold"><span
														th:text="'$' + ${#numbers.formatDecimal(detail.price * detail.quantity, 1, 2)}"></span>
													</td>

													<!-- 類型 -->
													<td class="text-center"><span
														th:if="${detail.isCustom == false}"
														class="badge bg-primary">一般商品</span> <span
														th:if="${detail.isCustom == true}"
														class="badge bg-success">客製化</span></td>
												</tr>
											</tbody>
										</table>

										<!-- ================= 退貨處理按鈕 ================= -->
										<div
											th:if="${orderData.order.returnStatus == '申請中' || orderData.order.returnStatus == '退貨中'}"
											class="d-flex justify-content-end mt-3">
											<button type="button" class="btn btn-success"
												data-bs-toggle="modal"
												th:data-bs-target="'#processReturnModal-' + ${orderData.order.orderId}">
												<i class="bi bi-check-circle"></i> 退貨處理
											</button>
										</div>

										<!-- ================= 退貨處理 Modal ================= -->
										<div
											th:if="${orderData.order.returnStatus == '申請中' || orderData.order.returnStatus == '退貨中'}"
											class="modal fade"
											th:id="'processReturnModal-' + ${orderData.order.orderId}"
											tabindex="-1" aria-labelledby="processReturnModalLabel"
											aria-hidden="true">
											<div class="modal-dialog modal-dialog-centered">
												<div class="modal-content">
													<form th:action="@{/returns/process}" method="post">
														<div class="modal-header">
															<h5 class="modal-title" id="processReturnModalLabel">
																<i class="bi bi-box-seam"></i> 退貨處理 - 訂單 #<span
																	th:text="${orderData.order.orderId}"></span>
															</h5>
															<button type="button" class="btn-close"
																data-bs-dismiss="modal" aria-label="Close"></button>
														</div>
														<div class="modal-body">
															<input type="hidden" name="orderId"
																th:value="${orderData.order.orderId}" />

															<!-- 處理方式下拉選單 -->
															<div class="mb-3">
																<label for="returnStatus" class="form-label">處理方式
																	<span class="text-danger">*</span>
																</label> <select class="form-select" id="returnStatus"
																	name="returnStatus"
																	th:data-order-id="${orderData.order.orderId}"
																	onchange="toggleRefusalReason(this)" required>
																	<option value="">請選擇處理方式</option>
																	<!-- 申請中狀態：可選擇所有處理方式 -->
																	<th:block
																		th:if="${orderData.order.returnStatus == '申請中'}">
																		<option value="RETURNING">同意退貨（退貨中）</option>
																		<option value="COMPLETED">退貨完成</option>
																		<option value="REJECTED">拒絕退貨</option>
																	</th:block>
																	<!-- 退貨中狀態：只能選擇退貨完成 -->
																	<th:block
																		th:if="${orderData.order.returnStatus == '退貨中'}">
																		<option value="COMPLETED">退貨完成</option>
																	</th:block>
																</select>
															</div>

															<!-- 拒絕原因下拉選單（動態顯示） -->
															<div class="mb-3"
																th:id="'refusalReasonDiv-' + ${orderData.order.orderId}"
																style="display: none;">
																<label for="refusalReason" class="form-label">拒絕原因
																	<span class="text-danger">*</span>
																</label> <select class="form-select" id="refusalReason"
																	name="refusalReason">
																	<option value="">請選擇拒絕原因</option>
																	<option value="USED">商品已使用</option>
																	<option value="DAMAGED">商品毀損</option>
																	<option value="CUSTOMIZED">客製化商品</option>
																	<option value="EXPIRED">超過鑑賞期</option>
																	<option value="PERSONAL">個人因素</option>
																</select>
															</div>
														</div>
														<div class="modal-footer">
															<button type="button" class="btn btn-secondary"
																data-bs-dismiss="modal">取消</button>
															<button type="submit" class="btn btn-success">
																<i class="bi bi-check-circle"></i> 送出
															</button>
														</div>
													</form>
												</div>
											</div>
										</div>
									</div>
								</div>
							</td>
						</tr>
					</th:block>
				</tbody>
			</table>
		</div>
		
        <!--登出確認Model -->
		<div class="modal fade" id="logoutModal" tabindex="-1"
			aria-labelledby="logoutModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="logoutModalLabel">確認登出</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">你確定要登出嗎？</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">取消</button>
						<button type="button" class="btn btn-danger"
							th:onclick="|window.location.href='@{/emp/logout}'|">
							確定登出</button>
					</div>
				</div>
			</div>
		</div>
	</main>

	<script>
		function toggleRefusalReason(selectElement) {
			var orderId = selectElement.getAttribute('data-order-id');
			var selectedValue = selectElement.value;
			var refusalReasonDiv = document.getElementById('refusalReasonDiv-'
					+ orderId);
			var refusalReasonSelect = refusalReasonDiv.querySelector('select');

			if (selectedValue === 'REJECTED') {
				// 顯示拒絕原因選單
				refusalReasonDiv.style.display = 'block';
				refusalReasonSelect.setAttribute('required', 'required');
			} else {
				// 隱藏拒絕原因選單
				refusalReasonDiv.style.display = 'none';
				refusalReasonSelect.removeAttribute('required');
				refusalReasonSelect.value = ''; // 清空選擇
			}
		}
	</script>
	
	<script>
		function loginWithLocation(element) {
		    const loginUrl = element.getAttribute('data-login-url') || '/emp/login';
		    
		    const redirectPath = '/returns/list'; 
		    
		    window.location.href = loginUrl + '?location=' + encodeURIComponent(redirectPath);
		}
	</script>

	<script
		th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js}"></script>

</body>
</html>
